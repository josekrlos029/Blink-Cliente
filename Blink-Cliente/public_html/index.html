<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="css/blink-theme-jqm.css" />
        <link rel="stylesheet" href="css/jquery.mobile.icons.min.css" />
        <link rel="stylesheet" href="css/jquery.mobile.structure-1.4.5.min.css" />
        <link rel="stylesheet" href="css/style.css" />
        <link href="css/chardinjs.css" rel="stylesheet">
        <script src="js/jquery-1.11.1.min.js"></script>
        <script src="js/jquery.mobile-1.4.5.min.js"></script>
        <script src="js/jquery.liveSearch.js"></script>
        <script src="js/app.js"></script>
        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBAibBz2Z0H3jFKhC9zguoL9jNU4fwlQGw&sensor=true&libraries=geometry"></script>
        <script src="js/gmaps.js"></script>
        <script src="phonegap.js" type="text/javascript"></script>
        <script type="text/javascript" charset="utf-8" src="PushNotification.js"></script>   
        <script src="cdv-plugin-fb-connect.js"></script>
        <script src="facebook-js-sdk.js"></script>
        <script>

            $(document).ready(function(){
                var cadena = $("#foot").html();
                
                $("#foot").html(cadena.replace(/&nbsp;/g,''));
            });
            
             var mapa, lt, ln;

            document.addEventListener("deviceready", onDeviceReady, false);
            document.addEventListener("menubutton", onMenuKeyDown, false);

            function onMenuKeyDown() {
                $("#btnMenu").click();
            }

            function onDeviceReady() {
                $("#btnPopup").hide();
                
                var $this = $(this),
                        theme = $this.jqmData("theme") || $.mobile.loader.prototype.options.theme,
                        msgText = $this.jqmData("msgtext") || $.mobile.loader.prototype.options.text,
                        textVisible = $this.jqmData("textvisible") || $.mobile.loader.prototype.options.textVisible,
                        textonly = !!$this.jqmData("textonly");
                html = $this.jqmData("html") || "";
                $.mobile.loading("show", {
                    text: msgText,
                    textVisible: textVisible,
                    theme: theme,
                    textonly: textonly,
                    html: html
                });
//                $("#contFecha").hide();
//                $("#contHora").hide();
//                FB.init({appId: "1428385527442767", nativeInterface: CDV.FB, useCachedDialogs: false});

                var dbExist = localStorage.getItem("dbExist");
                if (dbExist != "true") {
                    crearDb();
                }
                
                initPush();
                
                $("#mapa").height($(document).height() - $("#head").height() - $("#foot").height() - ($("#btnPopupDiligencia").height()*3));
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                     
                    var geocoder = new google.maps.Geocoder();
                    var yourLocation = new google.maps.LatLng(lat, lng);
                    
                    ubicarMapa(lat, lng);
                    geocoder.geocode({'latLng': yourLocation}, processGeocoder);
                    
                }, function() {
                    alert("Error al Obtener la Posición de su dispositivo, intente activar el GPS !");
                    location.href = "index.html";
                }, {enableHighAccuracy: true});

            }

            function processGeocoder(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (results[0]) {
                        var dir = results[0].formatted_address;
                        var array = dir.split(',');
                        localStorage.setItem("ubicacion",array[1]);
                        //$("#direccion").val(results[0].formatted_address);
                    } else {
                        alert("Error al Obtener Dirección");
                    }
                } else {
                    alert("Error al Obtener Dirección");
                }
            }

            function ubicarMapa(lat, lng) {
                mapa = new GMaps({
                    div: '#mapa',
                    lat: lat,
                    lng: lng,
                    zoom: 15,
                    zoomControl: false,
                    panControl: false,
                    streetViewControl: false,
                    mapTypeControl: false
                });

                agregarRuta(lat, lng);

            }

            function agregarRuta(lat, lng) {
                lt = lat;
                ln = lng;

                mapa.addMarker({
                    lat: lat,
                    lng: lng,
                    title: 'Mi ubicación',
                    animation: google.maps.Animation.DROP,
                    icon:  "image/map-user.png"
                    
                });
                $.mobile.loading("hide");

            }

            function envio() {
                
                var idUsuario= localStorage.getItem("idUsuario");
                var direccion= $("#direccion").val();
                var referencia= $("#referencias").val();
                var ciudad= localStorage.getItem("ubicacion");
                var servicio= $("input[name='servicio']:checked").val();
                var telefono= $("#telefono").val();
                var tipo= $("#tipo").val();
                var descripcion= $("#descripcion").val();
                var destino= $("#destino").val();
                var fecha= $("#fecha").val();
                var hora = $("#hora").val();
                
                if(direccion=="" || direccion==undefined || direccion==null || destino=="" || destino==undefined || destino==null || telefono=="" ||telefono==undefined ||telefono==null || descripcion=="" ||descripcion==undefined ||descripcion==null || tipo=="" ||tipo==undefined || tipo==null || servicio=="" ||servicio==undefined || servicio==null){
                    
                    alert("Por Favor Completa los Campos Obligatorios (*)");
                    
                }else{
                    
                    var $this = $(this),
                            theme = $this.jqmData("theme") || $.mobile.loader.prototype.options.theme,
                            msgText = $this.jqmData("msgtext") || $.mobile.loader.prototype.options.text,
                            textVisible = $this.jqmData("textvisible") || $.mobile.loader.prototype.options.textVisible,
                            textonly = !!$this.jqmData("textonly");
                    html = $this.jqmData("html") || "";
                    
                    $.mobile.loading("show", {
                        text: msgText,
                        textVisible: textVisible,
                        theme: theme,
                        textonly: textonly,
                        html: html
                    }); 

                    $("#btnEnvio").attr("disabled","disabled");
                    
                    var data = {
                        idUsuario: idUsuario,
                        direccion: direccion,
                        referencia: referencia,
                        ciudad: ciudad,
                        lat: lt,
                        lng: ln,
                        servicio: servicio,
                        telefono: telefono,
                        tipo: tipo,
                        descripcion: descripcion,
                        destino: destino,
                        fecha: fecha,
                        hora: hora
                    };

                    var url = "http://admin.blinkmanager.com/restaurante/registrarServicio";

                    $.ajax({
                        type: "POST",
                        url: url,
                        data: data
                    })
                            .done(function(msg) {
                                
                                var json = eval("(" + msg + ")");
                                if (json.msj == "exito") {
                                    alert("Tu Mensajero Llegará en cualquier momento a tu ubicación ");
                                    location.href="index.html";
                                }else if (json.msj == "cerrado") {
                                    alert("TuDomicilio está cerrado consulta los horarios de operación !");   
                                } else {
                                    alert("Error al hacer pedido, intenta mas tarde");
                                }
                                $.mobile.loading("hide");
                                $("#btnEnvio").removeAttr("disabled");
                                
                            });
                
                }
            }
            function facebook() {
                $("#closeLogin").click();
                if (localStorage.getItem("idUsuario") != "" && localStorage.getItem("idUsuario") != null) {
                    envio();
                } else {
                    FB.login(
                            function(response) {

                                if (response.authResponse)
                                {
                                    getUserInfo(); // Get User Information.
                                } else
                                {
                                    alert
                                            ('Error al entrar con facebook, intentalo nuevamente, Recuerda: "No publicaremos nada a tu nombre"');
                                }
                            }, {scope: 'email,publish_actions'}
                    );
                }

            }
            function getUserInfo() {
                FB.api('/me', function(response) {

                    var regId = localStorage.getItem('regId');
                    if (regId != "" && regId != null) {
                        var persona = {idFace: response.id,
                            nombres: response.first_name,
                            apellidos: response.last_name,
                            email: response.email,
                            fechaNacimiento: response.birthday,
                            regId: regId
                        };
                    }else{
                        var persona = {idFace: response.id,
                            nombres: response.first_name,
                            apellidos: response.last_name,
                            email: response.email,
                            fechaNacimiento: response.birthday,
                            token: localStorage.getItem("token")
                        };
                    }

                    confirmarRegistro(persona);
                });
            }
            
            
//Consulta en la bd del servidor si el usuario Existe... Sino Existe Lo agrega como nuevo usuario de la App
            function confirmarRegistro(persona) {
                //var url = "http://192.168.1.33/domicilios/restaurante/confirmarRegistroFace";
                var url = "http://admin.blinkmanager.com/restaurante/confirmarRegistroFace";

                $.ajax({
                    type: "POST",
                    url: url,
                    data: persona
                })
                        .done(function(msg) {
                            var json = eval("(" + msg + ")");
                            if (json.msj === "autenticado") {
                                localStorage.setItem('login', "true");
                                localStorage.setItem('idFace', persona.idFace);
                                localStorage.setItem('idUsuario', json.id);
                                envio();
                            } else if (json.msj === "registrado") {
                                alert("Registro Exitoso");
                                localStorage.setItem('login', "true");
                                localStorage.setItem('idFace', persona.idFace);
                                localStorage.setItem('idUsuario', json.id);
                                envio();
                            }
                        });
            }
        </script>
    </head>
    <body>
        <div data-role="page" id="pagina">

            <div data-role="header" id="head" data-position="fixed" data-fullscreen="false" style="padding: 0">
                <h3><img  src="image/logo.png" style="width: 80px;margin-top: 4px" /></h3>
                <!--<a href="#menu" id="btnMenu" style="border: none; background-color: #f7931e; box-shadow: none; margin-top: 11px" class="ui-nodisc-icon ui-btn ui-shadow ui-corner-all ui-icon-bars ui-btn-icon-notext ui-btn-a ui-btn-inline">Menù</a>-->
            </div>
            
           
            <!--<div data-role="panel" data-display="overlay" data-position="left" id="menu">
                <!--<input type="search" name="buscaRestaurante" id="buscaRestaurante" placeholder="Buscar Lugar">
                <div id="newSearch" style="width: 100%; z-index: 1000"></div> 
                <br>
                <ul data-role="listview" style="z-index: 0">
                    <li data-icon="home"><a data-ajax="false" href="index.html">Inicio</a></li>
                    <li data-icon="check"><a id="iniciar" data-ajax="false" href="iniciarSesion.html">Inicia Sesión</a></li>
                    <li data-icon="user"><a  id="perfil" data-ajax="false" href="perfil.html">Tu Perfil</a></li>
                    <li data-icon="shop"><a href="#" data-ajax="false" onclick="pedidos()">Pedidos</a></li>
                    <li data-icon="calendar"><a href="#" data-ajax="false" onclick="reservas()">Reservas</a></li>
                    <li data-icon="info"><a href="#" data-ajax="false" onclick="servicios()">Servicios</a></li>
                    <li data-icon="clock"><a href="diligencias.html" data-ajax="false">Diligencias</a></li>
                    <li data-icon="location"><a data-ajax="false" href="verCercanos.html">Lugares Cercanos</a></li>
                    <li data-icon="power"><a data-ajax="false" id="cerrar" href="#" onclick="cerrarSesion()">Cerrar Sesión</a></li>
                </ul>
            </div><!-- /panel -->
            <div role="main" id="mainPage" class="ui-content" style="padding: 0; margin: 0;">
                <div id="mapa" style="width: 100%"></div>
                <a href="#popupDiligencia" id="btnPopupDiligencia" data-rel="popup"  style="background-color: #20c05c; color: white; text-decoration: none;text-shadow: none" class="ui-btn ui-shadow ui-corner-all ui-icon-check ui-btn-icon-right boton">Solicitar Servicio</a>
                
                
                <a href="#popupLogin" id="btnPopup" hidden data-rel="popup"  style="background-color: #84aa1f; color: white; text-decoration: none;text-shadow: none" class="ui-btn ui-shadow ui-corner-all ui-icon-check ui-btn-icon-right boton">Aceptar</a>
                 
                <div style="padding: 10px" data-role="popup" id="popupDiligencia" data-overlay-theme="b" data-theme="b" class="ui-corner-all" data-dismissible="true">                    <h3>Nuestros Servicios</h3>
                <form>
                    <fieldset data-role="controlgroup">
                        <legend>*Escoge tu Servicio:</legend>
                        <input type="radio" name="servicio" id="radio-choice-v-2a" value="compra">
                        <label for="radio-choice-v-2a">Compras <strong>$3000</strong></label>
                        <input type="radio" name="servicio" id="radio-choice-v-2b" value="consignacion">
                        <label for="radio-choice-v-2b">Consignaciones <strong>$4000</strong></label>
                        <input type="radio" name="servicio" id="radio-choice-v-2c" value="envio">
                        <label for="radio-choice-v-2c">Envios <strong>$2000</strong></label>
                        <input type="radio" name="servicio" id="radio-choice-v-2d" value="factura">
                        <label for="radio-choice-v-2d">Pagos de Facturas <strong>$3000</strong></label>
                    </fieldset>
                </form>
                <br>
                <div class="ui-field-contain">
                    <label for="direccion"><b>*Origen:</b></label>
                    <input type="text" name="direccion" id="direccion" placeholder="Ej: Cra 5c # 20 - 54" value="">
                </div>
                <div class="ui-field-contain">
                    <label for="destino"><b>*Destino:</b></label>
                    <input type="text" name="destino" id="destino" placeholder="Ej: Cra 5c # 20 - 54" value="">
                </div>
                <div class="ui-field-contain">
                    <label for="referencias"><b>Referencias:</b></label>
                    <input type="text" name="referencias" id="referencias" placeholder="Ej: Sicarare, Junto al Parque Blanco" value="">
                </div>
                <div class="ui-field-contain">
                    <label for="descripcion"><b>*Descripción del Servicio:</b></label>
                    <textarea cols="40" rows="8" name="descripcion" id="descripcion" placeholder="Escriba aqui la descripción del pedido, Sea muy claro para prestar un servicio eficiente..."></textarea>
                </div>
                <div class="ui-field-contain">
                        <label for="telefono"><b>*Teléfono:</b></label>
                        <input type="number" max="12" min="8" name="telefono" id="telefono" placeholder="Teléfono" value="">
                </div> 
                <center><h4>Solicita tu mensajero, llegará al instante</h4></center>
                <a id="btnEnvio" style="background-color: #84aa1f; color: white; text-decoration: none;text-shadow: none" href="#" onclick="comprobarServicio();" data-ajax="false" class="ui-btn ui-shadow ui-corner-all ui-icon-check ui-btn-icon-right">Solicitar Mensajero</a>
                    
                </div>
                
                <div data-role="popup" id="popupLogin" data-overlay-theme="b" data-theme="b" class="ui-corner-all" data-dismissible="false">

                    <div style="padding:10px 20px;">
                        <a href="#" data-rel="back" id="closeLogin"  class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
                        <center><h5 style="text-align: center">Debes Iniciar Sesión</h5></center>
                        <center><h6>Registrate</h6></center>
                        <a href="registrarUsuario.html" data-ajax="false" class="ui-btn ui-shadow ui-corner-all ui-icon-mail ui-btn-icon-right ">Registrarse</a>
                        <!--<a href="#" onclick="facebook()" style="background-color: #4b67a1; color: white; text-decoration: none;text-shadow: none" class="ui-btn ui-shadow ui-corner-all ui-icon-user ui-btn-icon-right boton">Entra Con Facebook</a>-->
                        <center><h5 style="text-align: center">Ó Entra con tu correo</h5></center>
                        <label for="correo" class="ui-hidden-accessible">Correo:</label>
                        <input type="email" id="correo" placeholder="Correo" value="">
                        <label for="clave" class="ui-hidden-accessible">Contraseña:</label>
                        <input type="password" id="clave" placeholder="Contraseña" value="">
                        <button class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-right ui-icon-check" onclick="login()">Iniciar Sesión</button>
                    </div>
                </div>

            </div>
            
            
            
            <div data-role="footer" data-position="fixed" data-fullscreen="false"  id="foot" style="overflow:hidden;">
                <div data-role="navbar" >
                   <ul>
                        <li><a href="#" data-icon="clock" class="ui-btn-active"><p class="smallLetter">Diligencias</p></a></li>
                        <li><a data-ajax="false" href="tabRestaurantes.html" data-icon="location" ><p class="smallLetter">Restaurantes</p></a></li>
                        <li><a href="#" data-icon="star" onclick="licores()"><p class="smallLetter">Licores</p></a></li>                
                        <li><a onclick="servicios()" href=#" data-icon="info" data-ajax="false"><p class="smallLetter">Otros</p></a></li>
                        <!--<li><a href="carrito.html" data-ajax="false" data-icon="shop"><p class="smallLetter">Carrito</p></a></li>-->
                    </ul>
                </div><!-- /navbar -->
             </div>
            
        </div>
         

    </body>
</html>
